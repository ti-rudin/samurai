# Документация страниц приложения

## Раздел "Финансовый отчет" (/financial-report)

### Обзор
Страница финансового отчета предоставляет детальную аналитику финансовой деятельности автосервиса за выбранный период времени. Отчет включает информацию о выручке, расходах на исполнителей, стоимости запчастей и прибыли.

### Архитектура компонентов

#### Основной компонент (FinancialReport.vue)
Главный компонент страницы, который:
- Управляет состоянием отчета
- Координирует работу дочерних компонентов
- Обрабатывает события от дочерних компонентов

#### Компоненты интерфейса
- **PeriodFilter**: Компонент для выбора периода отчета
- **ClientRevenueTable**: Таблица выручки по клиентам
- **ExecutorEarningsTable**: Таблица начислений исполнителям

#### Композабл (useFinancialReport)
Отдельный модуль, содержащий всю бизнес-логику:
- Управление состоянием данных
- Расчет финансовых показателей
- Загрузка данных из API
- Обработка ошибок

### Основные возможности

#### Выбор периода отчета
- **Предустановленные периоды**:
  - Текущая неделя
  - Прошлая неделя
  - Текущий месяц
  - Прошлый месяц
- **Произвольный период**: Возможность выбора любой даты начала и окончания

#### Финансовые показатели
Отображаются ключевые метрики в виде карточек:
- **Выручка**: Общая сумма от завершенных работ
- **Расходы на исполнителей**: Сумма начислений всем исполнителям
- **Стоимость запчастей**: Общая стоимость использованных запчастей
- **Прибыль**: Разница между выручкой и расходами (с указанием маржинальности)

#### Анализ по клиентам
Таблица с разбивкой выручки по клиентам:
- Имя клиента и контактный телефон
- Количество завершенных заказов
- Сумма выручки
- Доля в общей выручке (в процентах)

#### Детализация по исполнителям
Расширяемая таблица с информацией о начислениях:
- Имя исполнителя
- Количество завершенных работ
- Сумма начислений
- Процент от общей суммы начислений
- Детальная разбивка по заказам и работам (при раскрытии)

### Логика расчета

#### Выручка
Сумма стоимости всех завершенных работ за выбранный период.

#### Расходы на исполнителей
Рассчитываются на основе процента вознаграждения от стоимости работы:
```
Начисление = Стоимость работы × Процент вознаграждения исполнителя / 100
```

#### Стоимость запчастей
Сумма стоимости всех запчастей (кроме рекомендованных) за период:
```
Стоимость запчастей = Σ(Количество × Цена) для всех запчастей
```

#### Прибыль
```
Прибыль = Выручка - Расходы на исполнителей - Стоимость запчастей
```

### Фильтрация данных
- Отчет включает только завершенные заказы (`orderstatus: 'completed'`)
- Работы фильтруются по дате завершения (`updatedAt` или `createdAt`)
- Запчасти учитываются для заказов с завершенными работами в периоде

### Отладочная информация
При отсутствии данных отображается блок с отладочной информацией:
- Выбранный период
- Количество найденных завершенных заказов
- Количество завершенных работ
- Дата последнего завершения работы
- Рекомендуемая неделя для анализа

## Раздел "Редактирование заказа" (/orders/:id/edit)

### Обзор
Страница редактирования заказа предоставляет полный набор инструментов для управления существующими заказами в автосервисе. Включает возможности редактирования данных заказа, управления работами и запчастями, обработки рекомендаций и финансовых расчетов.

### Структура страницы

#### Заголовок заказа (OrderHeader)
- Номер заказа и дата создания
- Информация о клиенте и автомобиле
- Статус заказа с цветовой индикацией

#### Управление статусом (OrderStatusManager)
Выбор статуса заказа из предопределенного списка:
- `new` - Новый заказ
- `in_progress` - В работе
- `suspended` - Приостановлен
- `completed` - Завершен
- `cancelled` - Отменен
- `deleted` - Удален

#### Информация о клиенте и автомобиле (ClientInfoCard)
- Данные клиента: имя, телефон, email, адрес
- Информация об автомобиле: марка, модель, год, VIN, госномер
- Назначенные механики

#### Описание работ (WorkDescriptionSection)
- Текстовое описание проблемы/работ
- Возможность генерации списка работ на основе описания
- Автоматическое сохранение изменений

### Управление работами (WorkSection)

#### Основные работы
- **Добавление работы**:
  - Название работы
  - Описание (Rich Text)
  - Стоимость
  - Статус (`pending`, `in_progress`, `completed`)
  - Назначение исполнителей (множественный выбор)
  - Процент вознаграждения исполнителя (0-100%)

- **Редактирование работы**:
  - Изменение всех параметров работы
  - Обновление статуса
  - Переназначение исполнителей
  - Корректировка стоимости

- **Удаление работы**:
  - Индивидуальное удаление
  - Массовое удаление выбранных работ

- **Пакетное назначение исполнителей**:
  - Выбор нескольких работ
  - Назначение одного или нескольких исполнителей на все выбранные работы
  - Установка процента вознаграждения

#### Рекомендованные работы (RecommendationsSection)
- Отображение рекомендованных работ отдельно от основных
- Возможность добавления рекомендованных работ в основные
- Редактирование рекомендованных работ
- Удаление рекомендованных работ
- Создание полного заказа на основе всех рекомендаций

### Управление запчастями (PartsSection)

#### Основные запчасти
- **Добавление запчасти**:
  - Артикул (номер)
  - Название
  - Количество
  - Цена
  - Статус (`pending_from_client`, `need_to_order`, `ordered`, `onbase`)
  - Флаг "Рекомендована"

- **Редактирование запчасти**:
  - Изменение всех параметров
  - Обновление статуса и количества

- **Удаление запчасти**:
  - Индивидуальное удаление
  - Массовое удаление

#### Рекомендованные запчасти
- Аналогично рекомендованным работам
- Отдельное управление от основных запчастей

### Финансовый раздел (FinanceSection)
- **Расчет стоимости основных работ**: Сумма всех основных работ
- **Расчет стоимости основных запчастей**: Сумма всех основных запчастей
- **Общая стоимость основных элементов**: Сумма работ + запчастей
- **Расчет стоимости рекомендованных работ**: Сумма рекомендованных работ
- **Расчет стоимости рекомендованных запчастей**: Сумма рекомендованных запчастей
- **Общая стоимость рекомендованных элементов**: Сумма рекомендованных работ + запчастей

### Примечания (NotesSection)
- Текстовые примечания к заказу
- Автоматическое отслеживание изменений
- Сохранение примечаний

### Модальные окна
- **WorkItemModal**: Модальное окно для работы с работами
- **PartItemModal**: Модальное окно для работы с запчастями
- **BatchAssignExecutorModal**: Модальное окно для пакетного назначения исполнителей

### Техническая архитектура

#### Композаблы (Composables)
- **useOrderEdit**: Основной композабл для управления редактированием заказа
- **useOrderWorks**: Управление работами
- **useOrderParts**: Управление запчастями
- **useOrderCalculations**: Финансовые расчеты
- **useOrderRecommendations**: Обработка рекомендаций
- **useOrderNotes**: Управление примечаниями
- **useOrderData**: Загрузка справочных данных

#### Состояние и хранение
- **orders.js**: Store для заказов
- **workStore.js**: Store для работ
- Реактивное обновление данных при изменениях

### Процессы и бизнес-логика

#### Создание заказа на основе рекомендаций
1. Пользователь просматривает рекомендованные работы и запчасти
2. Выбирает необходимые элементы
3. Нажимает "Создать заказ из рекомендаций"
4. Система создает новый заказ со всеми выбранными элементами
5. Перенаправляет на страницу редактирования нового заказа

#### Финансовые расчеты
- Автоматический пересчет стоимости при каждом изменении
- Разделение на основные и рекомендованные элементы
- Учет процента вознаграждения исполнителей в стоимости работ

#### Валидация данных
- Обязательные поля при создании работ и запчастей
- Проверка корректности числовых значений
- Валидация процента вознаграждения (0-100%)

### API взаимодействия

#### Работа с заказами
- `GET /api/orders/:id` - Получение данных заказа
- `PUT /api/orders/:id` - Обновление заказа
- `POST /api/orders` - Создание нового заказа

#### Работа с работами
- `GET /api/works?order=:id` - Получение работ заказа
- `POST /api/works` - Создание работы
- `PUT /api/works/:id` - Обновление работы
- `DELETE /api/works/:id` - Удаление работы

#### Работа с запчастями
- `GET /api/parts?order=:id` - Получение запчастей заказа
- `POST /api/parts` - Создание запчасти
- `PUT /api/parts/:id` - Обновление запчасти
- `DELETE /api/parts/:id` - Удаление запчасти

#### Работа с исполнителями
- `GET /api/users` - Получение списка пользователей
- `PUT /api/works/:id/executors` - Назначение исполнителей на работу

## Навигация и маршрутизация

### Доступ к страницам
- **Финансовый отчет**: `/financial-report` (доступен авторизованным пользователям)
- **Редактирование заказа**: `/orders/:id/edit` (где :id - ID заказа)

### Переходы между страницами
- Из списка заказов в редактирование заказа
- Из финансового отчета в детали заказа
- Создание нового заказа из рекомендаций

## Производительность и оптимизация

### Ленивая загрузка
- Компоненты загружаются по мере необходимости
- Данные подгружаются постранично

### Кеширование
- Локальное хранение справочных данных
- Кеширование результатов API запросов

### Реактивные вычисления
- Автоматический пересчет финансовых показателей
- Оптимизированные вычисляемые свойства Vue.js

## Безопасность

### Аутентификация и авторизация
- Проверка прав доступа к операциям
- Валидация данных на frontend и backend
- Защита от несанкционированного доступа

### Валидация данных
- Проверка входных данных
- Санитизация пользовательского ввода
- Обработка ошибок и исключений

## Мониторинг и логирование

### Логирование действий
- Запись всех изменений в заказах
- Логирование финансовых операций
- Отслеживание действий пользователей

### Обработка ошибок
- Graceful handling ошибок
- Информативные сообщения пользователю
- Fallback состояния интерфейса
