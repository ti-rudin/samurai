# Функциональность редактирования заказа

## Обзор
Функциональность редактирования заказа предоставляет полный набор инструментов для управления заказами в автосервисе. Она включает в себя возможности редактирования основных данных заказа, управления работами и запчастями, обработки рекомендаций и финансовых расчетов.

## Основные компоненты

### 1. Заголовок заказа (OrderHeader)
- Отображение номера заказа и даты создания
- Информация о клиенте и автомобиле
- Статус заказа с цветовой индикацией

### 2. Управление статусом (OrderStatusManager)
- Выбор статуса заказа из предопределенного списка:
  - `new` - Новый
  - `in_progress` - В работе
  - `suspended` - Приостановлен
  - `completed` - Завершен
  - `cancelled` - Отменен
  - `deleted` - Удален
- Автоматическое обновление статуса при изменениях

### 3. Информация о клиенте и автомобиле (ClientInfoCard)
- Данные клиента: имя, телефон, email, адрес
- Информация об автомобиле: марка, модель, год, VIN, госномер
- Назначенные механики

## Вложенные функции

### Управление работами (WorkSection)

#### Основные работы
- **Добавление работы**:
  - Название работы
  - Описание (Rich Text)
  - Стоимость
  - Статус (`pending`, `in_progress`, `completed`)
  - Назначение исполнителей (множественный выбор)
  - Процент вознаграждения исполнителя (0-100%)

- **Редактирование работы**:
  - Изменение всех параметров работы
  - Обновление статуса
  - Переназначение исполнителей
  - Корректировка стоимости

- **Удаление работы**:
  - Индивидуальное удаление
  - Массовое удаление выбранных работ

- **Пакетное назначение исполнителей**:
  - Выбор нескольких работ
  - Назначение одного или нескольких исполнителей на все выбранные работы
  - Установка процента вознаграждения

#### Рекомендованные работы (RecommendationsSection)
- Отображение рекомендованных работ отдельно от основных
- Возможность добавления рекомендованных работ в основные
- Редактирование рекомендованных работ
- Удаление рекомендованных работ
- Создание полного заказа на основе всех рекомендаций

### Управление запчастями (PartsSection)

#### Основные запчасти
- **Добавление запчасти**:
  - Артикул (номер)
  - Название
  - Количество
  - Цена
  - Статус (`pending_from_client`, `need_to_order`, `ordered`, `onbase`)
  - Флаг "Рекомендована"

- **Редактирование запчасти**:
  - Изменение всех параметров
  - Обновление статуса и количества

- **Удаление запчасти**:
  - Индивидуальное удаление
  - Массовое удаление

#### Рекомендованные запчасти
- Аналогично рекомендованным работам
- Отдельное управление от основных запчастей

### Описание работ (WorkDescriptionSection)
- Текстовое описание проблемы/работ
- Возможность генерации списка работ на основе описания
- Автоматическое сохранение изменений

### Финансовый раздел (FinanceSection)
- **Расчет стоимости основных работ**: Сумма всех основных работ
- **Расчет стоимости основных запчастей**: Сумма всех основных запчастей
- **Общая стоимость основных элементов**: Сумма работ + запчастей
- **Расчет стоимости рекомендованных работ**: Сумма рекомендованных работ
- **Расчет стоимости рекомендованных запчастей**: Сумма рекомендованных запчастей
- **Общая стоимость рекомендованных элементов**: Сумма рекомендованных работ + запчастей

### Примечания (NotesSection)
- Текстовые примечания к заказу
- Автоматическое отслеживание изменений
- Сохранение примечаний

## Техническая архитектура

### Композаблы (Composables)
- **useOrderEdit**: Основной композабл для управления редактированием заказа
- **useOrderWorks**: Управление работами
- **useOrderParts**: Управление запчастями
- **useOrderCalculations**: Финансовые расчеты
- **useOrderRecommendations**: Обработка рекомендаций
- **useOrderNotes**: Управление примечаниями
- **useOrderData**: Загрузка справочных данных

### Состояние и хранение
- **orders.js**: Store для заказов
- **workStore.js**: Store для работ
- Реактивное обновление данных при изменениях

### Модальные окна
- **WorkItemModal**: Модальное окно для работы с работами
- **PartItemModal**: Модальное окно для работы с запчастями
- **BatchAssignExecutorModal**: Модальное окно для пакетного назначения исполнителей

## Процессы и бизнес-логика

### Создание заказа на основе рекомендаций
1. Пользователь просматривает рекомендованные работы и запчасти
2. Выбирает необходимые элементы
3. Нажимает "Создать заказ из рекомендаций"
4. Система создает новый заказ со всеми выбранными элементами
5. Перенаправляет на страницу редактирования нового заказа

### Финансовые расчеты
- Автоматический пересчет стоимости при каждом изменении
- Разделение на основные и рекомендованные элементы
- Учет процента вознаграждения исполнителей в стоимости работ

### Валидация данных
- Обязательные поля при создании работ и запчастей
- Проверка корректности числовых значений
- Валидация процента вознаграждения (0-100%)

## API взаимодействия

### Работа с заказами
- `GET /api/orders/:id` - Получение данных заказа
- `PUT /api/orders/:id` - Обновление заказа
- `POST /api/orders` - Создание нового заказа

### Работа с работами
- `GET /api/works?order=:id` - Получение работ заказа
- `POST /api/works` - Создание работы
- `PUT /api/works/:id` - Обновление работы
- `DELETE /api/works/:id` - Удаление работы

### Работа с запчастями
- `GET /api/parts?order=:id` - Получение запчастей заказа
- `POST /api/parts` - Создание запчасти
- `PUT /api/parts/:id` - Обновление запчасти
- `DELETE /api/parts/:id` - Удаление запчасти

### Работа с исполнителями
- `GET /api/users` - Получение списка пользователей
- `PUT /api/works/:id/executors` - Назначение исполнителей на работу

## Обработка ошибок и уведомления
- Отображение ошибок при неудачных операциях
- Успешные уведомления при сохранении данных
- Информационные сообщения о процессах

## Производительность
- Ленивая загрузка данных при инициализации
- Реактивные вычисления для автоматического обновления интерфейса
- Оптимизированные запросы к API с минимальным количеством вызовов

## Безопасность
- Валидация входных данных на frontend и backend
- Проверка прав доступа к операциям
- Защита от CSRF атак
- Логирование действий пользователей
